name: Daily Health Scan

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  scan:
    runs-on: ubuntu-latest
    name: Run Domain Health Scan
    steps:
      - name: Trigger Scan
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ vars.ZONESHIFT_URL }}/api/scan/all" \
            -H "Content-Type: application/json" \
            -H "x-scan-secret: ${{ secrets.SCAN_SECRET }}" \
            --max-time 300)

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Scan failed with HTTP $HTTP_CODE"
            exit 1
          fi

          # Extract summary
          echo "$BODY" | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          if data.get('success'):
              s = data.get('summary', {})
              print(f\"Scanned {data['domainsScanned']} domains\")
              print(f\"  Healthy:  {s.get('healthy', 0)}\")
              print(f\"  Warning:  {s.get('warning', 0)}\")
              print(f\"  Critical: {s.get('critical', 0)}\")
              print(f\"  Avg Score: {s.get('avgScore', 0)}\")
          else:
              print(f\"Error: {data.get('error', 'Unknown')}\")
              sys.exit(1)
          " || echo "Could not parse response"
